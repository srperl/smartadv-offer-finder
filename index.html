<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>SmartADV Offer Finder (Test Subset)</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
  <style>
    body {
      font-family: 'Poppins', sans-serif;
      background-color: #ffffff;
      padding: 20px;
      color: #1a1a1a;
    }
    h1 {
      color: #00a4e4;
      text-align: center;
      margin-bottom: 30px;
    }
    .filters {
      margin-bottom: 30px;
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      justify-content: center;
    }
    select, input[type="text"] {
      padding: 8px 10px;
      font-size: 14px;
      border: 1px solid #ccc;
      border-radius: 6px;
      min-width: 160px;
    }
    #offers {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 16px;
    }
    .offer-card {
      background: #f4f9fb;
      padding: 12px;
      border-radius: 8px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
      font-size: 14px;
    }
    .offer-card img {
      width: 100%;
      height: 100px;
      object-fit: cover;
      border-radius: 5px;
      margin-bottom: 8px;
    }
    .highlight {
      font-style: italic;
      color: #15803d;
      font-weight: 600;
    }
    .apply-link {
      display: inline-block;
      margin-top: 8px;
      background: #f26522;
      color: #fff;
      padding: 6px 10px;
      border-radius: 4px;
      font-weight: bold;
      text-decoration: none;
    }
    .score-label {
      font-weight: bold;
      color: #00a4e4;
      margin-top: 4px;
    }
  </style>
</head>
<body>

<h1>SmartADV Offer Finder</h1>

<div class="filters">
  <select id="categoryFilter" multiple size="4"></select>
  <select id="channelFilter" multiple size="4"></select>
  <select id="countryFilter" multiple size="4"></select>
  <input type="text" id="searchInput" placeholder="Search by Offer Name or ID..." />
</div>

<div id="offers">Loading offers...</div>

<script>
  const apiKey = 'patnPgIMAMI9ZXwum.7860eff03b9c59d78ad536532edb41bd347c6900e8f9724681452fd68757097a';
  const baseId = 'app12gesbScGlSR9r';
  const tableName = 'Imported table';

  const filters = {
    category: document.getElementById('categoryFilter'),
    channel: document.getElementById('channelFilter'),
    country: document.getElementById('countryFilter'),
    search: document.getElementById('searchInput')
  };

  let offers = [];

  const affiliatePreferences = {
    categories: ['Health', 'CBD'],
    channels: ['Push', 'Email'],
    countries: ['US', 'CA']
  };

  function getAIScore(f) {
    let score = 0;
    if ((f.Category || []).some(c => affiliatePreferences.categories.includes(c))) score++;
    if ((f.Channels || []).some(c => affiliatePreferences.channels.includes(c))) score++;
    if ((f.Countries || []).some(c => affiliatePreferences.countries.includes(c))) score++;
    return score;
  }

  function renderOffers(data) {
    const container = document.getElementById('offers');
    if (!data.length) {
      container.innerHTML = '<p>No matching offers found.</p>';
      return;
    }

    container.innerHTML = data.map((r, i) => {
      const f = r.fields;
      const img = f['thumbnail url'] || 'https://via.placeholder.com/300x150?text=SmartADV';
      const name = f.Name || 'Unnamed Offer';
      const score = getAIScore(f);
      const scoreLabel = score >= 2 ? `<p class="score-label">✨ AI Matched Offer</p>` : '';
      const highlight = ['🔥 Hot offer!', '🚀 Trending pick!', '💰 High EPC!'][i % 3];

      return `
        <div class="offer-card">
          <img src="${img}" alt="${name}" />
          <div><strong>#${f['Offer ID'] || 'N/A'}</strong> - ${name}</div>
          <p><strong>Category:</strong> ${(f.Category || []).join(', ')}</p>
          <p><strong>GEOs:</strong> ${(f.Countries || []).join(', ')}</p>
          <p><strong>Channels:</strong> ${(f.Channels || []).join(', ')}</p>
          <p class="highlight">${highlight}</p>
          ${scoreLabel}
          <a class="apply-link" href="${f['Portal Link']}" target="_blank">Apply Now</a>
        </div>
      `;
    }).join('');
  }

  function applyFilters(data) {
    const cat = [...filters.category.selectedOptions].map(o => o.value);
    const chan = [...filters.channel.selectedOptions].map(o => o.value);
    const geo = [...filters.country.selectedOptions].map(o => o.value);
    const kw = filters.search.value.toLowerCase();

    return data.filter(r => {
      const f = r.fields;
      const kwMatch = !kw || (f.Name || '').toLowerCase().includes(kw) || (f['Offer ID'] || '').toString().includes(kw);
      const catMatch = !cat.length || (f.Category || []).some(c => cat.includes(c));
      const chanMatch = !chan.length || (f.Channels || []).some(c => chan.includes(c));
      const geoMatch = !geo.length || (f.Countries || []).some(c => geo.includes(c));
      return kwMatch && catMatch && chanMatch && geoMatch;
    });
  }

  function update() {
    const filtered = applyFilters(offers);
    renderOffers(filtered);
  }

  function populateDropdowns(data) {
    const sets = { category: new Set(), channel: new Set(), country: new Set() };
    data.forEach(r => {
      (r.fields.Category || []).forEach(val => sets.category.add(val));
      (r.fields.Channels || []).forEach(val => sets.channel.add(val));
      (r.fields.Countries || []).forEach(val => sets.country.add(val));
    });

    Object.entries(sets).forEach(([key, set]) => {
      const el = filters[key];
      el.innerHTML = '';
      [...set].sort().forEach(val => {
        const opt = document.createElement('option');
        opt.value = val;
        opt.textContent = val;
        el.appendChild(opt);
      });
    });
  }

  function fetchData() {
    fetch(`https://api.airtable.com/v0/${baseId}/${tableName}?filterByFormula={test subset}=1&maxRecords=50`, {
      headers: { Authorization: `Bearer ${apiKey}` }
    })
      .then(res => res.json())
      .then(json => {
        offers = json.records;
        populateDropdowns(offers);
        renderOffers(offers);
      })
      .catch(err => {
        document.getElementById('offers').innerHTML = '⚠️ Error loading offers.';
        console.error(err);
      });
  }

  // Event bindings
  Object.values(filters).forEach(el => {
    el.addEventListener('input', update);
    el.addEventListener('change', update);
  });

  fetchData();
</script>
</body>
</html>






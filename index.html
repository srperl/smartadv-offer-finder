<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>SmartADV Offer Finder</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
  <style>
    body {
      font-family: 'Poppins', sans-serif;
      background-color: #ffffff;
      padding: 20px;
      color: #1a1a1a;
    }
    h1 {
      color: #0070f3;
      text-align: center;
      margin-bottom: 30px;
    }
    .filters {
      margin-bottom: 30px;
      display: flex;
      flex-wrap: wrap;
      gap: 15px;
      justify-content: center;
    }
    select, input[type="text"] {
      padding: 10px;
      font-size: 14px;
      border: 1px solid #ccc;
      border-radius: 6px;
    }
    .offer-section {
      margin-top: 40px;
    }
    .offer-section h2 {
      color: #333;
      margin-bottom: 15px;
      font-size: 1.5rem;
      border-bottom: 2px solid #eee;
      padding-bottom: 5px;
    }
    .offer-card {
      background-color: #f9f9f9;
      padding: 15px;
      margin-bottom: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.05);
      display: flex;
      align-items: flex-start;
      gap: 15px;
    }
    .offer-card img {
      width: 120px;
      height: auto;
      border-radius: 6px;
    }
    .offer-content {
      flex: 1;
    }
    .offer-content h3 {
      margin: 0;
      color: #0070f3;
      font-size: 1.2rem;
    }
    .highlight {
      font-style: italic;
      margin: 10px 0;
      color: #666;
    }
    .offer-content p {
      margin: 5px 0;
    }
    .apply-link {
      display: inline-block;
      margin-top: 10px;
      color: #fff;
      background-color: #0070f3;
      padding: 6px 12px;
      border-radius: 4px;
      text-decoration: none;
      font-weight: 600;
    }
    .tags {
      margin-top: 5px;
      font-size: 12px;
      color: #fff;
      background: #28a745;
      padding: 4px 6px;
      border-radius: 3px;
      display: inline-block;
    }
    .copy-btn {
      margin-left: 10px;
      background: #e0e0e0;
      border: none;
      padding: 4px 6px;
      font-size: 12px;
      cursor: pointer;
      border-radius: 3px;
    }
  </style>
</head>
<body>
  <h1>SmartADV Offer Finder</h1>

  <div class="filters">
    <select id="categoryFilter" multiple size="5"></select>
    <select id="channelFilter" multiple size="5"></select>
    <select id="countryFilter" multiple size="5"></select>
    <select id="payoutFilter">
      <option value="">Any Payout</option>
      <option value="low">Under $50</option>
      <option value="mid">$50 - $100</option>
      <option value="high">Over $100</option>
    </select>
    <select id="sortFilter">
      <option value="">Sort by...</option>
      <option value="payout-high">Payout: High to Low</option>
      <option value="payout-low">Payout: Low to High</option>
      <option value="epc-high">EPC: High to Low</option>
    </select>
    <input type="text" id="searchInput" placeholder="Search keyword..." />
  </div>

  <div id="offers">Loading offers...</div>

  <script>
    const apiKey = 'patnPgIMAMI9ZXwum.7860eff03b9c59d78ad536532edb41bd347c6900e8f9724681452fd68757097a';
    const baseId = 'app12gesbScGlSR9r';
    const tableName = 'Imported table';

    fetch(`https://api.airtable.com/v0/${baseId}/${tableName}?maxRecords=50&filterByFormula={test subset}=1`, {
      headers: { Authorization: `Bearer ${apiKey}` },
    })
      .then(res => res.json())
      .then(data => {
        const container = document.getElementById('offers');
        const categoryFilter = document.getElementById('categoryFilter');
        const channelFilter = document.getElementById('channelFilter');
        const countryFilter = document.getElementById('countryFilter');
        const payoutFilter = document.getElementById('payoutFilter');
        const sortFilter = document.getElementById('sortFilter');
        const searchInput = document.getElementById('searchInput');

        const offers = data.records || [];
        const categories = new Set();
        const channels = new Set();
        const countries = new Set();

        offers.forEach(r => {
          (r.fields.Category || []).forEach(c => categories.add(c));
          (r.fields.Channels || []).forEach(c => channels.add(c));
          (r.fields.Countries || []).forEach(c => countries.add(c));
        });

        categories.forEach(c => categoryFilter.innerHTML += `<option value="${c}">${c}</option>`);
        channels.forEach(c => channelFilter.innerHTML += `<option value="${c}">${c}</option>`);
        countries.forEach(c => countryFilter.innerHTML += `<option value="${c}">${c}</option>`);

        function generateHighlight(f) {
          const epc = parseFloat(f.EPC || 0);
          const payout = parseFloat(f.Payout || 0);
          const terms = f['Terms and Conditions'] || '';
          if (epc > 1.5) return 'üí∏ EPC crushing it! High return for every click!';
          if (payout > 100) return 'üí∞ Big bounty alert! Over $100 per conversion!';
          if (terms.includes('no brand bidding')) return '‚ö†Ô∏è Strict compliance, but high reward!';
          if (f['Top Performer']) return 'üî• A proven top performer. Don‚Äôt miss out!';
          return 'üéØ Solid offer with strong metrics. Perfect for scaling.';
        }

        function renderOffers() {
          const cat = Array.from(categoryFilter.selectedOptions).map(o => o.value);
          const chan = Array.from(channelFilter.selectedOptions).map(o => o.value);
          const geo = Array.from(countryFilter.selectedOptions).map(o => o.value);
          const keyword = searchInput.value.toLowerCase();
          const payout = payoutFilter.value;
          const sort = sortFilter.value;

          const filtered = offers.filter(r => {
            const f = r.fields;
            const matchCategory = !cat.length || cat.some(c => (f.Category || []).includes(c));
            const matchChannel = !chan.length || chan.some(c => (f.Channels || []).includes(c));
            const matchCountry = !geo.length || geo.some(c => (f.Countries || []).includes(c));
            const matchKeyword = !keyword || (f.Name || '').toLowerCase().includes(keyword) || (f.Description || '').toLowerCase().includes(keyword);
            const payoutValue = parseFloat(f.Payout || 0);
            const matchPayout = !payout ||
              (payout === 'low' && payoutValue < 50) ||
              (payout === 'mid' && payoutValue >= 50 && payoutValue <= 100) ||
              (payout === 'high' && payoutValue > 100);
            return matchCategory && matchChannel && matchCountry && matchKeyword && matchPayout;
          });

          if (sort === 'payout-high') filtered.sort((a, b) => (parseFloat(b.fields.Payout || 0)) - (parseFloat(a.fields.Payout || 0)));
          else if (sort === 'payout-low') filtered.sort((a, b) => (parseFloat(a.fields.Payout || 0)) - (parseFloat(b.fields.Payout || 0)));
          else if (sort === 'epc-high') filtered.sort((a, b) => (parseFloat(b.fields.EPC || 0)) - (parseFloat(a.fields.EPC || 0)));

          const grouped = {};
          filtered.forEach(r => {
            const group = (r.fields.Category || ['Uncategorized'])[0];
            if (!grouped[group]) grouped[group] = [];
            grouped[group].push(r);
          });

          container.innerHTML = Object.entries(grouped).map(([cat, list]) => {
            return `<div class="offer-section">
              <h2>${cat}</h2>
              ${list.map(record => {
                const f = record.fields;
                const tag = f["Brand Bidding Only"] ? `<span class="tags">Brand Bidding ‚úÖ</span>` : '';
                const top = f["Top Performer"] ? `<span class="tags" style="background:#ff5722">üî• Top Performer</span>` : '';
                const epc = f.EPC ? `<p><strong>EPC:</strong> $${f.EPC}</p>` : '';
                const highlightLine = generateHighlight(f);
                return `
                  <div class="offer-card">
                    <img src="${f['thumbnail url'] || ''}" alt="${f.Name}" />
                    <div class="offer-content">
                      <h3>${f.Name || 'Unnamed Offer'}</h3>
                      <p><strong>Category:</strong> ${f.Category?.join(', ') || 'N/A'}</p>
                      <p><strong>Payout:</strong> $${f.Payout || 'N/A'}</p>
                      <p><strong>GEOs:</strong> ${f.Countries?.join(', ') || 'N/A'}</p>
                      <p class="highlight">${highlightLine}</p>
                      ${epc} ${tag} ${top}
                      <div>
                        <a class="apply-link" href="${f['Portal Link']}" target="_blank">Apply Now</a>
                        <button class="copy-btn" onclick="navigator.clipboard.writeText('${f['Portal Link']}')">üìã Copy</button>
                      </div>
                    </div>
                  </div>
                `;
              }).join('')}
            </div>`;
          }).join('');
        }

        [categoryFilter, channelFilter, countryFilter, searchInput, payoutFilter, sortFilter].forEach(input => {
          input.addEventListener('input', renderOffers);
        });

        renderOffers();
      })
      .catch(err => {
        document.getElementById('offers').innerHTML = "‚ö†Ô∏è Error loading offers.";
        console.error(err);
      });
  </script>
</body>
</html>
